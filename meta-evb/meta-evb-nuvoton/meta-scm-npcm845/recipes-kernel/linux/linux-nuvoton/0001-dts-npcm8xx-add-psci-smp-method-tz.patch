From 021e513277ee39f525f69a3985ae38053059c1a0 Mon Sep 17 00:00:00 2001
From: invalid_git config <unknown@unknown>
Date: Thu, 12 May 2022 02:26:41 +0000
Subject: [PATCH 2/2] dts: npcm8xx: add psci smp method tz

Signed-off-by: Stanley Chu <yschu@nuvoton.com>
---
 .../dts/nuvoton/nuvoton-common-npcm8xx.dtsi   |  5 +++
 .../boot/dts/nuvoton/nuvoton-npcm845.dtsi     | 41 +++++++++++++++----
 2 files changed, 38 insertions(+), 8 deletions(-)

diff --git a/arch/arm64/boot/dts/nuvoton/nuvoton-common-npcm8xx.dtsi b/arch/arm64/boot/dts/nuvoton/nuvoton-common-npcm8xx.dtsi
index afe20ac97ad3..871b69833b92 100644
--- a/arch/arm64/boot/dts/nuvoton/nuvoton-common-npcm8xx.dtsi
+++ b/arch/arm64/boot/dts/nuvoton/nuvoton-common-npcm8xx.dtsi
@@ -109,6 +109,11 @@
 			#interrupt-cells = <3>;
 			interrupt-controller;
 			#address-cells = <0>;
+			ppi-partitions {
+				ppi_cluster0: interrupt-partition-0 {
+					affinity = <&cpu0 &cpu1 &cpu2 &cpu3>;
+				};
+			};
 		};
 	};
 
diff --git a/arch/arm64/boot/dts/nuvoton/nuvoton-npcm845.dtsi b/arch/arm64/boot/dts/nuvoton/nuvoton-npcm845.dtsi
index 8a2969761b04..2559c1378648 100644
--- a/arch/arm64/boot/dts/nuvoton/nuvoton-npcm845.dtsi
+++ b/arch/arm64/boot/dts/nuvoton/nuvoton-npcm845.dtsi
@@ -19,8 +19,8 @@
 			clocks = <&clk NPCM8XX_CLK_CPU>;
 			reg = <0x0 0x0>;
 			next-level-cache = <&l2>;
-			enable-method = "spin-table";
-			cpu-release-addr = <0x0 0xF0800E00>;
+			enable-method = "psci";
+			cpu-idle-states = <&CPU_SLEEP>;
 		};
 
 		cpu1: cpu@1 {
@@ -29,8 +29,8 @@
 			clocks = <&clk NPCM8XX_CLK_CPU>;
 			reg = <0x0 0x1>;
 			next-level-cache = <&l2>;
-			enable-method = "spin-table";
-			cpu-release-addr = <0x0 0xF0800E00>;
+			enable-method = "psci";
+			cpu-idle-states = <&CPU_SLEEP>;
 		};
 
 		cpu2: cpu@2 {
@@ -39,8 +39,8 @@
 			clocks = <&clk NPCM8XX_CLK_CPU>;
 			reg = <0x0 0x2>;
 			next-level-cache = <&l2>;
-			enable-method = "spin-table";
-			cpu-release-addr = <0x0 0xF0800E00>;
+			enable-method = "psci";
+			cpu-idle-states = <&CPU_SLEEP>;
 		};
 
 		cpu3: cpu@3 {
@@ -49,15 +49,40 @@
 			clocks = <&clk NPCM8XX_CLK_CPU>;
 			reg = <0x0 0x3>;
 			next-level-cache = <&l2>;
-			enable-method = "spin-table";
-			cpu-release-addr = <0x0 0xF0800E00>;
+			enable-method = "psci";
+			cpu-idle-states = <&CPU_SLEEP>;
 		};
 
+		idle-states {
+			entry-method = "psci";
+			CPU_SLEEP: cpu-sleep {
+				compatible = "arm,idle-state";
+				local-timer-stop;
+				arm,psci-suspend-param = <0x00010001>;
+				entry-latency-us = <200>;
+				exit-latency-us = <200>;
+				min-residency-us = <800>;
+			};
+		};
 		l2: l2-cache {
 			compatible = "cache";
 		};
 	};
 
+	arm-pmu {
+		compatible = "arm,cortex-a35-pmu";
+		interrupts = <GIC_SPI 242 IRQ_TYPE_LEVEL_HIGH>,
+			     <GIC_SPI 243 IRQ_TYPE_LEVEL_HIGH>,
+			     <GIC_SPI 244 IRQ_TYPE_LEVEL_HIGH>,
+			     <GIC_SPI 245 IRQ_TYPE_LEVEL_HIGH>;
+		interrupt-affinity = <&cpu0>, <&cpu1>, <&cpu2>, <&cpu3>;
+	};
+
+	psci {
+		compatible      = "arm,psci-1.0";
+		method          = "smc";
+	};
+
 	timer {
 		compatible = "arm,armv8-timer";
 		interrupts = <GIC_PPI 13 (GIC_CPU_MASK_SIMPLE(4) | IRQ_TYPE_LEVEL_LOW)>,
-- 
2.17.1


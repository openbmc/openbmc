# Witherspoon fan policy for PDM.
#
# Witherspoon requires a minimum of two functional fans.
# If the number of functional fans drops below that
# power the system off.

- name: fans
  description: >
    'Witherspoon has four fans to monitor.'
  class: group
  group: path
  members:
    - meta: FAN
      path: /xyz/openbmc_project/inventory/system/chassis/motherboard/fan0
    - meta: FAN
      path: /xyz/openbmc_project/inventory/system/chassis/motherboard/fan1
    - meta: FAN
      path: /xyz/openbmc_project/inventory/system/chassis/motherboard/fan2
    - meta: FAN
      path: /xyz/openbmc_project/inventory/system/chassis/motherboard/fan3

- name: chassis
  description: >
    'Witherspoon has a single chassis to monitor.'
  class: group
  group: path
  members:
    - meta: CHASSIS
      path: /xyz/openbmc_project/state/chassis0

- name: fan present
  description: >
    'Monitor the presence state of each fan.'
  class: group
  group: property
  type: boolean
  members:
    - interface: xyz.openbmc_project.Inventory.Item
      meta: PRESENT
      property: Present

- name: fan functional
  description: >
    'Monitor the functional state of each fan.'
  class: group
  group: property
  type: boolean
  members:
    - interface: xyz.openbmc_project.State.Decorator.OperationalStatus
      meta: FUNCTIONAL
      property: Functional

- name: chassis powered
  description: >
    'Monitor the chassis power state.'
  class: group
  group: property
  type: string
  members:
    - interface: xyz.openbmc_project.State.Chassis
      meta: CHASSIS_STATE
      property: CurrentPowerState

- name: watch fan present
  description: >
    'Trigger logic on fan presence state changes.'
  class: watch
  watch: property
  paths: fans
  properties: fan present
  callback: check fans

- name: watch fan functional
  description: >
    'Trigger logic on fan functional state changes.'
  class: watch
  watch: property
  paths: fans
  properties: fan functional
  callback: check fans

- name: watch chassis
  description: >
    'Trigger logic on chassis power state changes.'
  class: watch
  watch: property
  paths: chassis
  properties: chassis powered
  callback: check fans

- name: check fans
  description: >
    'Verify there are at least two functional fans.'
  class: callback
  callback: group
  members:
    - check presence
    - check functional

- name: check presence
  description: >
    'If this condition passes more than two fans have been uplugged
    for more than five seconds.  Shut the system down.'
  class: condition
  condition: count
  paths: fans
  properties: fan present
  defer: 5000000us
  callback: check power
  countop: '<'
  countbound: 2
  op: '=='
  bound: true

- name: check functional
  description: >
    'If this condition passes more than two fans have been nonfunctional
    for more than five seconds.  Shut the system down.'
  class: condition
  condition: count
  paths: fans
  properties: fan functional
  defer: 5000000us
  callback: check power
  countop: '>'
  countbound: 2
  op: '=='
  bound: false

- name: check power
  description: >
    'If the chassis has power, power it off.'
  class: condition
  condition: count
  paths: chassis
  properties: chassis powered
  callback: log and shutdown
  countop: '>'
  countbound: 0
  op: '=='
  bound: xyz.openbmc_project.State.Chassis.PowerState.On

- name: log and shutdown
  description: >
    'Shut the system down and log an event.'
  class: callback
  callback: group
  members:
    - shutdown
    - log

- name: shutdown
  description: >
    'Shut down the system.'
  class: callback
  callback: method
  service: org.freedesktop.systemd1
  path: /org/freedesktop/systemd1
  interface: org.freedesktop.systemd1.Manager
  method: StartUnit
  args:
    - value: obmc-host-shutdown@0.target
      type: string
    - value: replace
      type: string

- name: log
  description: >
    'Log a shutdown event to the systemd journal.'
  class: callback
  callback: journal
  paths: chassis
  properties: chassis powered
  severity: ERR
  message: Shutting down system.  There are not enough functional fans.

From ce64633b9733e962b8d8482244301f614d8b5845 Mon Sep 17 00:00:00 2001
From: Khem Raj <raj.khem@gmail.com>
Date: Mon, 22 Aug 2016 22:54:24 -0700
Subject: [PATCH] Check for malloc_trim before using it

malloc_trim is gnu specific and not all libc
implement it, threfore write a configure check
to poke for it first and use the define to
guard its use.

Helps in compiling on musl based systems

Signed-off-by: Khem Raj <raj.khem@gmail.com>
---
Upstream-Status: Submitted [https://github.com/ikeydoherty/cve-check-tool/pull/48]
 configure.ac | 2 ++
 src/core.c   | 4 ++--
 2 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/configure.ac b/configure.ac
index d3b66ce..79c3542 100644
--- a/configure.ac
+++ b/configure.ac
@@ -19,6 +19,8 @@ m4_define([json_required_version], [0.16.0])
 m4_define([openssl_required_version],[1.0.0])
 # TODO: Set minimum sqlite
 
+AC_CHECK_FUNCS_ONCE(malloc_trim)
+
 PKG_CHECK_MODULES(CVE_CHECK_TOOL,
                  [
                   glib-2.0 >= glib_required_version,
diff --git a/src/core.c b/src/core.c
index 6263031..0d5df29 100644
--- a/src/core.c
+++ b/src/core.c
@@ -498,9 +498,9 @@ bool cve_db_load(CveDB *self, const char *fname)
         }
 
         b = true;
-
+#ifdef HAVE_MALLOC_TRIM
         malloc_trim(0);
-
+#endif
         xmlFreeTextReader(r);
         if (fd) {
                 close(fd);
-- 
2.9.3


#!/bin/bash
# shellcheck source=meta-facebook/meta-bletchley/recipes-bletchley/plat-tools/files/bletchley-common-functions
source /usr/libexec/bletchley-common-functions

CMD=$1
SLED_INDEX=""
if [ "$#" -ge 2 ]; then
    SLED_INDEX=$(sled_mapping "$2")
fi

DEVMEM_MUX_REG=0x1e780088
DEVMEM_MUX_DIR_REG=0x1e78008C # mux gpio driection

declare -A MUX_NIBBLES=(
    ["1"]="C"    # 1100 -> C
    ["2"]="D"    # 1101 -> D
    ["3"]="E"    # 1110 -> E
    ["4"]="3"    # 0011 -> 3
    ["5"]="7"    # 0111 -> 7
    ["6"]="B"    # 1011 -> B
    ["off"]="F"  # 1111 -> F
)

set_upper_nibble() {
    local reg=$1
    local target_nibble=$((0x$2))
    local current_val
    local current_nibble
    local new_val
    local new_val_hex
    local mask=0xFFFF0FFF
    local verify_val

    current_val=$(devmem "$reg")
    current_nibble=$(( (current_val >> 12) & 0xF ))

    if [ "$current_nibble" -eq "$target_nibble" ]; then
        return 0
    fi

    new_val=$(( (current_val & mask) | (target_nibble << 12 ) ))
    new_val_hex=$(printf "0x%08X" "$new_val")

    devmem "$reg" 32 "$new_val_hex"
    verify_val=$(devmem "$reg")
    if (( new_val == verify_val )); then
        echo "Register $reg is written from $current_val to $new_val_hex"
        return 0
    else
        echo "Register $reg failed to set from $current_val to $new_val_hex"
        return 1
    fi
}

print_help()
{
    echo "Usage:"
    echo "    bletchley-usbmux-util off"
    echo "    bletchley-usbmux-util on <SLED_INDEX>"
    echo ""
    echo "SLED_INDEX: 1 - $MAX_SLED_NUM"
    echo ""
}

# set mux gpio driection to output
set_mux_gpio_direction()
{
    set_upper_nibble "$DEVMEM_MUX_DIR_REG" "F"
}

usb_mux_off()
{
    set_upper_nibble "$DEVMEM_MUX_REG" "${MUX_NIBBLES[off]}"
    sleep 3
    if [ -d "/sys/bus/usb/devices/1-1" ]; then
        echo 1e6a1000.usb > /sys/bus/platform/drivers/ehci-platform/unbind
        sleep 3
        echo 1e6a1000.usb > /sys/bus/platform/drivers/ehci-platform/bind
        sleep 3
    fi
}

usb_mux_sled()
{
    local sled_num=$1
    usb_mux_off
    set_upper_nibble "$DEVMEM_MUX_REG" "${MUX_NIBBLES[$sled_num]}"
}

set_mux_gpio_direction

if [ "$CMD" == "off" ]; then
    usb_mux_off
    exit 0
elif [ "$CMD" == "on" ]; then
    if [[ -z "$SLED_INDEX" ]]; then
        echo "SLED index is required"
        exit 1
    fi

    if (( $2 >= 1 && $2 <= MAX_SLED_NUM )); then
        usb_mux_sled "$SLED_INDEX"
    else
        echo "Invalid SLED index: $2"
        print_help
        exit 1
    fi
else
    echo "Invalid command: $CMD"
    print_help
    exit 1
fi

sleep 3

if [ ! -d "/sys/bus/usb/devices/1-1" ]; then
    echo 1e6a1000.usb > /sys/bus/platform/drivers/ehci-platform/unbind
    sleep 3
    echo 1e6a1000.usb > /sys/bus/platform/drivers/ehci-platform/bind
    sleep 3
fi

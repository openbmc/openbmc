#!/bin/bash

I2C_BUS=10
DEV_ADDR=0x40

is_valid_hdc1080()
{
    local prev_id=""
    local dev_id

    for _ in {1..10}; do
        if ! dev_id=$(i2ctransfer -y -f "$I2C_BUS" w1@"$DEV_ADDR" 0xff r2 2>/dev/null); then
            prev_id=""
            sleep 0.1
            continue
        fi

        if [ -n "$dev_id" ]; then
            if [ "$dev_id" = "$prev_id" ]; then
                [ "$dev_id" = "0x10 0x50" ] && return 0 || return 1
            fi
            prev_id="$dev_id"
        fi
        sleep 0.1
    done

    return 1
}

set_frontpanel_model()
{
    busctl set-property xyz.openbmc_project.Settings /xyz/openbmc_project/inventory/system/chassis0/frontpanel xyz.openbmc_project.Inventory.Decorator.Asset Model s "Bletchley_FPB_${1}"
}

VIRT_SNR_CONF="/var/lib/phosphor-virtual-sensor/virtual_sensor_config.json"
HDC1080_VIRT_SNR_CONF="/usr/share/phosphor-virtual-sensor/virtual_sensor_config_hdc1080.json"
SI7021_VIRT_SNR_CONF="/usr/share/phosphor-virtual-sensor/virtual_sensor_config_si7021.json"

# Check chip type
if is_valid_hdc1080; then
    CHIP_TYPE="HDC1080"
else
    CHIP_TYPE="SI7021"
fi

# Set Frontpanel board model
set_frontpanel_model "$CHIP_TYPE"

# Setup virtual_sensor_config.json for phosphor-virtual-sensor
case "$CHIP_TYPE" in
"HDC1080")
    REQUIRED_CONF_PATH="$HDC1080_VIRT_SNR_CONF"
    ;;
"SI7021")
    REQUIRED_CONF_PATH="$SI7021_VIRT_SNR_CONF"
    ;;
*)
    REQUIRED_CONF_PATH="$HDC1080_VIRT_SNR_CONF"
    ;;
esac

if [ ! -d "$(dirname $VIRT_SNR_CONF)" ]; then
    mkdir -p "$(dirname $VIRT_SNR_CONF)"
fi

if [ ! -e "$VIRT_SNR_CONF" ]; then
    ln -s "$REQUIRED_CONF_PATH" "$VIRT_SNR_CONF"
else
    REAL_CONF_PATH="$(realpath $VIRT_SNR_CONF)"
    if [ "$REAL_CONF_PATH" != "$REQUIRED_CONF_PATH" ]; then
        rm "$VIRT_SNR_CONF"
        ln -s "$REQUIRED_CONF_PATH" "$VIRT_SNR_CONF"
    fi
fi

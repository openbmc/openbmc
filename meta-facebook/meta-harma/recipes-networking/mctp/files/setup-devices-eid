#!/bin/bash

bic_addr=0x20
bic_busnum=9
nic_addr=50
nic_busnum=1
nic_eid=90
maxRetries=10

# Retry a command with optional failover command
retry_command() {
    local command="$1"
    local maxRetries=${2:-10}
    local retryInterval=${3:-1}
    local failExecuteCmd=${4:-""}
    local retries=0

    while [ "$retries" -lt "$maxRetries" ]; do
        if bash -c "$command" 2>&1; then
            return 0
        else
            if [ -n "$failExecuteCmd" ]; then
                bash -c "$failExecuteCmd"
            fi

            retries=$((retries + 1))
            sleep "$retryInterval"
        fi
    done

    echo "[Error] Command failed after $maxRetries retries." >&2
    return 1
}

setup_bic_eid() {
    # Check if the endpoint exists
    if busctl introspect au.com.codeconstruct.MCTP1 /au/com/codeconstruct/mctp1/networks/1/endpoints/10; then
        echo "[Info] BIC endpoint already exists, removing..."
        busctl call au.com.codeconstruct.MCTP1 \
            /au/com/codeconstruct/mctp1/networks/1/endpoints/10 \
            au.com.codeconstruct.MCTP.Endpoint1 Remove
    fi

    # Learn BIC Endpoint
    learn_endpoint_cmd="busctl call au.com.codeconstruct.MCTP1 \
        /au/com/codeconstruct/mctp1/interfaces/mctpi2c${bic_busnum} \
        au.com.codeconstruct.MCTP.BusOwner1 LearnEndpoint ay 1 ${bic_addr}"

    if ! retry_command "$learn_endpoint_cmd" "$maxRetries" 1; then
        echo "[Error] Failed to learn BIC EID after $maxRetries attempts."
    fi
}

setup_nic_eid() {
    # Set local EID for NIC
    assign_endpoint_cmd="busctl call au.com.codeconstruct.MCTP1 \
        /au/com/codeconstruct/mctp1/interfaces/mctpi2c${nic_busnum} \
        au.com.codeconstruct.MCTP.BusOwner1 \
        AssignEndpointStatic ayy 1 ${nic_addr} ${nic_eid}"

    if ! retry_command "$assign_endpoint_cmd" "$maxRetries" 1; then
        echo "[Error] Failed to assign NIC EID after $maxRetries attempts."
    fi
}

setup_bic_eid
setup_nic_eid

exit 0

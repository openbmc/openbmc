#!/bin/bash

# shellcheck source=meta-facebook/meta-santabarbara/recipes-phosphor/state/phosphor-state-manager/power-cmd
source /usr/libexec/phosphor-state-manager/power-cmd
source /usr/libexec/fb-common-functions

# Remove EID for SWB
# Supports i3c hub for EVT 2A and later phases
if [ "$(get_gpio "MB_REV_ID_1")" -ne 0 ] || [ "$(get_gpio "MB_REV_ID_2")" -ne 0 ]; then
    hub_devices=$(i2cdetect -l | grep "hub2-" | grep "\.port2")
    if [[ -n "$hub_devices" ]]; then
        hub_id=$(echo "$hub_devices" | grep -oEm1 "hub2-[a-f0-9]+" | awk '!seen[$0]++')
        i2c_num=$(echo "$hub_devices" | grep "$hub_id\.port2" | awk '{print $1}' | cut -d'-' -f2)
        eid=$(mctp route | grep "mctpi2c$i2c_num" | grep -oE "eid min [0-9]+" | awk '{print $3}' | head -n1)
        if [[ -n "$eid" ]]; then
            busctl call au.com.codeconstruct.MCTP1 \
                /au/com/codeconstruct/mctp1/networks/1/endpoints/"$eid" \
                au.com.codeconstruct.MCTP.Endpoint1 Remove 2>/dev/null || true
        fi
    fi
fi

currentstate=$(busctl get-property \
    xyz.openbmc_project.State.Host0 \
    /xyz/openbmc_project/state/host0 \
    xyz.openbmc_project.State.Host \
    CurrentHostState | awk '{print $2}' | tr -d '"')

if [ "$currentstate" == "xyz.openbmc_project.State.Host.HostState.TransitioningToOff" ]; then
    exit 0
fi

active=$(systemctl is-active host-graceful-poweroff@0.service)
if [ -z "$active" ] || [ "$active" != "inactive" ]; then
    exit 0
fi

active=$(systemctl is-active host-force-poweroff@0.service)
if [ -z "$active" ] || [ "$active" != "inactive" ]; then
    exit 0
fi

active=$(systemctl is-active host-powerreset@0.service)
if [ -z "$active" ] || [ "$active" != "inactive" ]; then
    exit 0
fi

sleep 3
# Sync power state to "off" for abnormal power lose.
transition=$(busctl get-property \
    xyz.openbmc_project.State.Host0 \
    /xyz/openbmc_project/state/host0 \
    xyz.openbmc_project.State.Host \
    RequestedHostTransition | awk '{print $2}' | tr -d '"')

if [ "$transition" != "xyz.openbmc_project.State.Host.Transition.Off" ] && [ "$(power_status)" == "off" ]; then
    busctl set-property xyz.openbmc_project.State.Host0 \
        /xyz/openbmc_project/state/host0 \
        xyz.openbmc_project.State.Host \
        RequestedHostTransition s \
        xyz.openbmc_project.State.Host.Transition.Off
fi
exit 0